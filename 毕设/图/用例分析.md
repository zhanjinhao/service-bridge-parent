## 系统流图

**单节点流图**

<div align="center"><img width="100%" src="http://blogfileqiniu.isjinhao.site/640eea40-ff9f-464b-bf7a-0fde3b59e02b" /></div>
**集群流图**

<div align="center"><img width="100%" src="http://blogfileqiniu.isjinhao.site/2e10316e-0aa1-4c9a-9894-4635de468494" /></div>


## 用例图

<div align="center"><img width="100%" src="http://blogfileqiniu.isjinhao.site/980f5e98-81c1-40d0-bd17-f3bc68756f0b" /></div>


## 名词解释

- 单体应用（monomer application）：传统的应用。
- 微服务系统（microservice system）：一个微服务系统由三个部分组成，提供者、消费者、注册中心。
- 提供者（provider）：此提供者不是某个微服务系统的提供者，而指的是图上右侧的单体应用或微服务系统。
- 消费者（consumer）：此提供者不是某个微服务系统的消费者，而指的是图上左侧的代理端或微服务系统。
- 服务集合（service set）：一个jar包内包含多个接口。一个接口是一个服务，一个jar包是一个服务集合。
- 拉取服务驱动（pull service driver）：用于从提供者的系统中加载服务。
- 暴露服务驱动（expose service driver）：用于将服务暴露给指定的微服务系统。
- pull配置文件（pull config properties）：保存提供者的信息，如IP和端口等。存在一个配置文件中。
- expose配置文件（expose config properties）：保存消费者的信息，如IP和端口等。存在一个配置文件中。
- pull注册中心（pull registry）：系统加载pull配置文件到内存中后对应的对象。
- expose注册中心（expose registry）：系统加载expose配置文件到内存中后对应的对象。



## 适用场景

系统是一种逻辑模型，支持热部署的编程语言都具有实现此模型的能力。

相比于gRPC这种跨语言的框架，此系统基本不能适用于多种编程语言的环境。其只适合用于在同种编程语言内整合已存在的系统，如Java语言内著名的开发栈，Servlet、SSH、SSM、Dubbo、SofaRPC、SpringCloud之间可以进行整合。相比于gRPC等跨语言的框架，它的优势在于不需要修改已存在的服务。

开发此系统的目的是为了解决如下应用场景的问题。公司已存在一个由SSM开发的登录系统，随着业务的扩充，新的业务使用了分布式系统，但是我不想重构登录系统，便可以搭一个中间系统将登录系统作为一个服务注册到分布式系统中去。同时如果有一个已存在的日志系统，也可以作为一个服务注册到分布式系统去。也就是说此系统起了一个集线器的功能。

对于跨语言的业务需求，主要需要解决的是消息传输协议和实体类序列化这两个问题。如果借助gRPC这样的框架，那么剩下的需要解决便是如何传输实体类序列化这个问题。此问题不在此版本中解决。也就是此版本只能做到同种编程语言内的服务整合。

如果非要支持多种编程语言，可以使用暴露出来的HTTP接口。



## 加载expose包

**正常事件流**

1. 系统扫描expose包
2. 系统依次加载expose包



## 加载pull包

**正常事件流**

1. 系统扫描pull包
2. 系统依次加载pull包

**备选事件流**

2a：系统不存在pull包

1. 系统退出



## 加载配置文件

**正常事件流**

1. 系统加载配置文件
2. 系统根据配置文件构造注册中心（pull类型和expose类型）
3. 系统将加载工具绑定至新构建的注册中心
4. 系统返回加载成功

**备选事件流**

2a：配置文件不存在

1. 系统返回加载失败

2b：配置文件格式错误

1. 系统返回加载失败

2c：配置文件已加载

1. 系统返回配置文件已加载

3a：加载工具不存在

1. 系统返回加载工具不存在



## 系统服务发现

**正常事件流**

1. 读取配置文件的注册中心信息
2. 获取注册中心的服务信息
3. 返回注册中心的服务信息



## 初始化配置文件

**正常事件流**

1. 系统扫描配置文件
2. 系统加载配置文件
3. 系统发现注册中心上的服务



## 创建服务容器

**正常事件流**

1. 管理员输入pull注册中心ID、服务名、版本号（此三元组是一个服务的唯一标识）
2. 系统创建服务容器
3. 系统返回创建成功

**备选事件流**

2a：pull注册中心不存在

1. 系统返回创建失败

2b：服务已存在

1. 系统返回服务容器已存在



## 加载接口

**正常事件流**

1. 管理员输入pull注册中心ID、服务名、版本号、jar包名
2. 系统加载jar包
3. 系统返回加载成功

**备选事件流**

2a：服务容器不存在

1. 系统返回加载失败

2b：jar包不存在

1. 系统返回加载失败

2c：jar包已加载

1. 系统返回jar包失败



## 加载服务

**正常事件流**

1. 管理员输入pull注册中心ID、服务名、版本号、接口名（可以有一个备选的方式，加载jar包中全部的接口）
2. 系统加载服务

**前置条件**

- pull配置文件加载成功
- 服务容器创建成功
- 接口加载成功



## 暴露服务

**正常事件流**

1. 管理员输入pull注册中心ID、expose注册中心ID、服务名、版本号
2. 系统暴露服务至expose注册中心

**前置条件**

- expose配置文件加载成功
- 服务加载成功



## 服务消费

**正常事件流**

1. 用户输入pull注册中心、服务名、版本号、方法名、参数
2. 系统调用服务

**前置条件**

- 服务加载成功



## 消费者服务发现

**正常事件流**

1. 消费者/管理员发送服务发现请求
2. 系统返回已加载/暴露的服务信息



## 服务存活监听

**正常事件流**

1. 系统每隔一段时间从pull注册中心获取服务的状态
2. 系统更新服务的状态为存活

**备选事件流**

2a：获取操作超时

1. 系统更新服务的状态为超时

2b：获取服务失败

1. 系统更新服务的状态为死亡



## 服务断线重连

**正常事件流**

1. 系统监测到服务状态为非存活状态时重试



## 关闭服务暴露

**正常事件流**

1. 管理员输入pull注册中心ID、expose注册中心ID、服务名、版本号
2. 系统关闭服务暴露
3. 系统返回关闭服务暴露成功

**备选事件流**

2a：服务不存在

1. 返回服务不存在



## 卸载服务

**正常事件流**

1. 管理员输入pull注册中心、服务名、版本号
2. 系统关闭和此服务有关的已暴露的服务
3. 系统释放已加载的jar包
4. 系统删除此服务容器
5. 系统返回卸载成功

**前置条件**

- 服务加载成功
- 关闭服务暴露成功